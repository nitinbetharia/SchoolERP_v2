<!-- AUTH-02-001: Session Login - Fully Responsive -->
<% layout('../layouts/auth') %>

<!-- Login form container -->
<div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 lg:p-10 border border-gray-100">
    <!-- Form header -->
    <div class="text-center mb-6 sm:mb-8">
        <h2 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 mb-2">
            Welcome Back
        </h2>
        <p class="text-sm sm:text-base text-gray-600 leading-relaxed">
            Sign in to your account to access the 
            <span class="hidden sm:inline">school management </span>system
        </p>
    </div>

    <!-- Login form -->
    <form 
        method="POST" 
        action="/auth/login" 
        class="space-y-4 sm:space-y-6" 
        data-validate
        novalidate
        autocomplete="on"
    >
        <!-- CSRF token (if implemented) -->
        <input type="hidden" name="_csrf" value="<%= locals.csrfToken || '' %>">

        <!-- Email/Username field -->
        <%- include('../partials/form-controls/input', {
            id: 'email',
            name: 'email',
            type: 'email',
            label: 'Email Address',
            placeholder: 'Enter your email address',
            value: locals.formData?.email || '',
            required: true,
            autocomplete: 'username email',
            error: locals.fieldErrors?.email,
            icon: `<path fill-rule="evenodd" d="M14.828 14.828a4 4 0 01-5.656 0M9 10a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" clip-rule="evenodd" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />`
        }) %>

        <!-- Password field -->
        <%- include('../partials/form-controls/input', {
            id: 'password',
            name: 'password',
            type: 'password',
            label: 'Password',
            placeholder: 'Enter your password',
            value: '',
            required: true,
            autocomplete: 'current-password',
            error: locals.fieldErrors?.password,
            minLength: '6',
            help: 'Minimum 6 characters required'
        }) %>

        <!-- Remember me & Forgot password -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0">
            <!-- Remember me checkbox -->
            <div class="flex items-center">
                <input 
                    id="remember-me" 
                    name="remember_me" 
                    type="checkbox" 
                    value="true"
                    <%= locals.formData?.remember_me ? 'checked' : '' %>
                    class="h-4 w-4 text-tenant-primary focus:ring-tenant-primary border-gray-300 rounded transition-colors duration-200"
                >
                <label for="remember-me" class="ml-2 block text-sm text-gray-700 cursor-pointer">
                    Remember me
                </label>
            </div>

            <!-- Forgot password link -->
            <div>
                <a 
                    href="/auth/forgot-password" 
                    class="text-sm text-tenant-primary hover:text-tenant-secondary transition-colors duration-200 font-medium"
                >
                    Forgot password?
                </a>
            </div>
        </div>

        <!-- Sign in button -->
        <div class="pt-2">
            <%- include('../partials/form-controls/button', {
                type: 'submit',
                text: 'Sign In',
                variant: 'primary',
                size: 'lg',
                fullWidth: true,
                ariaLabel: 'Sign in to your account',
                icon: `<path fill-rule="evenodd" d="M3 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zm7.707 3.293a1 1 0 010 1.414L9.414 9H17a1 1 0 110 2H9.414l1.293 1.293a1 1 0 01-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0z" clip-rule="evenodd" />`,
                iconPosition: 'left'
            }) %>
        </div>
    </form>

    <!-- Alternative login methods (if enabled) -->
    <% if (locals.trust?.settings?.enable_sso || locals.trust?.settings?.enable_otp_login) { %>
        <div class="mt-6 sm:mt-8">
            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">Or continue with</span>
                </div>
            </div>

            <div class="mt-4 space-y-3">
                <!-- OTP Login -->
                <% if (locals.trust?.settings?.enable_otp_login) { %>
                    <%- include('../partials/form-controls/button', {
                        type: 'button',
                        text: 'Sign in with OTP',
                        variant: 'outline',
                        size: 'md',
                        fullWidth: true,
                        onclick: 'showOTPLogin()',
                        icon: `<path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />`,
                        iconPosition: 'left'
                    }) %>
                <% } %>

                <!-- SSO Login -->
                <% if (locals.trust?.settings?.enable_sso) { %>
                    <%- include('../partials/form-controls/button', {
                        href: '/auth/sso/redirect',
                        text: 'Sign in with SSO',
                        variant: 'outline',
                        size: 'md',
                        fullWidth: true,
                        icon: `<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />`,
                        iconPosition: 'left'
                    }) %>
                <% } %>
            </div>
        </div>
    <% } %>

    <!-- Registration link (if enabled) -->
    <% if (locals.trust?.settings?.enable_registration) { %>
        <div class="mt-6 sm:mt-8 text-center">
            <p class="text-sm text-gray-600">
                Don't have an account? 
                <a 
                    href="/auth/register" 
                    class="font-medium text-tenant-primary hover:text-tenant-secondary transition-colors duration-200"
                >
                    Sign up here
                </a>
            </p>
        </div>
    <% } %>

    <!-- Help & Support -->
    <div class="mt-6 sm:mt-8 pt-6 border-t border-gray-200">
        <div class="text-center">
            <p class="text-xs text-gray-500 mb-3">
                Need help? Contact your system administrator or
            </p>
            <div class="flex flex-col sm:flex-row sm:justify-center space-y-2 sm:space-y-0 sm:space-x-4 text-xs">
                <a 
                    href="tel:<%= locals.trust?.settings?.support_phone || '+91-XXX-XXX-XXXX' %>" 
                    class="text-tenant-primary hover:text-tenant-secondary transition-colors duration-200 flex items-center justify-center sm:justify-start"
                >
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                    </svg>
                    Call Support
                </a>
                <a 
                    href="mailto:<%= locals.trust?.settings?.support_email || 'support@schoolerp.com' %>" 
                    class="text-tenant-primary hover:text-tenant-secondary transition-colors duration-200 flex items-center justify-center sm:justify-start"
                >
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                    </svg>
                    Email Support
                </a>
            </div>
        </div>
    </div>
</div>

<!-- OTP Login Modal (hidden by default) -->
<% if (locals.trust?.settings?.enable_otp_login) { %>
    <div id="otp-login-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-gray-900 mb-2">Sign in with OTP</h3>
                <p class="text-sm text-gray-600">
                    Enter your registered mobile number to receive an OTP
                </p>
            </div>

            <form id="otp-form" method="POST" action="/auth/otp/request" class="space-y-4">
                <%- include('../partials/form-controls/input', {
                    id: 'phone-otp',
                    name: 'phone',
                    type: 'tel',
                    label: 'Mobile Number',
                    placeholder: 'Enter your mobile number',
                    required: true,
                    autocomplete: 'tel',
                    pattern: '[6-9]\\d{9}',
                    help: 'Enter 10-digit mobile number'
                }) %>

                <div class="flex space-x-3">
                    <%- include('../partials/form-controls/button', {
                        type: 'submit',
                        text: 'Send OTP',
                        variant: 'primary',
                        size: 'md',
                        class: 'flex-1'
                    }) %>
                    
                    <%- include('../partials/form-controls/button', {
                        type: 'button',
                        text: 'Cancel',
                        variant: 'outline',
                        size: 'md',
                        onclick: 'hideOTPLogin()',
                        class: 'flex-1'
                    }) %>
                </div>
            </form>
        </div>
    </div>
<% } %>

<!-- JavaScript for enhanced functionality -->
<script>
    // OTP Login modal functions
    <% if (locals.trust?.settings?.enable_otp_login) { %>
        function showOTPLogin() {
            document.getElementById('otp-login-modal').classList.remove('hidden');
            document.getElementById('otp-login-modal').classList.add('flex');
            document.getElementById('phone-otp').focus();
        }

        function hideOTPLogin() {
            document.getElementById('otp-login-modal').classList.add('hidden');
            document.getElementById('otp-login-modal').classList.remove('flex');
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideOTPLogin();
            }
        });

        // Close modal on backdrop click
        document.getElementById('otp-login-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideOTPLogin();
            }
        });
    <% } %>

    // Enhanced form validation
    document.addEventListener('DOMContentLoaded', function() {
        const loginForm = document.querySelector('form[data-validate]');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');

        // Real-time email validation
        emailInput.addEventListener('blur', function() {
            const email = this.value.trim();
            if (email && !isValidEmail(email)) {
                SchoolERP.forms.showFieldErrors(this, ['Please enter a valid email address']);
            } else {
                SchoolERP.forms.showFieldErrors(this, []);
            }
        });

        // Real-time password validation
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const errors = [];
            
            if (password.length > 0 && password.length < 6) {
                errors.push('Password must be at least 6 characters long');
            }
            
            SchoolERP.forms.showFieldErrors(this, errors);
        });

        // Enhanced form submission
        loginForm.addEventListener('submit', function(e) {
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            if (!email || !password) {
                e.preventDefault();
                SchoolERP.utils.showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (!isValidEmail(email)) {
                e.preventDefault();
                emailInput.focus();
                SchoolERP.forms.showFieldErrors(emailInput, ['Please enter a valid email address']);
                return;
            }

            if (password.length < 6) {
                e.preventDefault();
                passwordInput.focus();
                SchoolERP.forms.showFieldErrors(passwordInput, ['Password must be at least 6 characters long']);
                return;
            }

            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            SchoolERP.utils.showLoading(submitBtn);
        });

        // Email validation helper
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Auto-fill detection for better UX
        function checkAutoFill() {
            if (emailInput.value && passwordInput.value) {
                // Likely auto-filled, enable submit button
                loginForm.querySelector('button[type="submit"]').focus();
            }
        }

        // Check for auto-fill after a delay
        setTimeout(checkAutoFill, 100);
    });

    // Caps lock detection
    document.addEventListener('keydown', function(e) {
        const capsLockWarning = document.getElementById('caps-lock-warning');
        
        if (e.getModifierState('CapsLock') && e.target.type === 'password') {
            if (!capsLockWarning) {
                const warning = document.createElement('div');
                warning.id = 'caps-lock-warning';
                warning.className = 'mt-1 text-xs text-yellow-600 flex items-center';
                warning.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    Caps Lock is on
                `;
                e.target.parentNode.appendChild(warning);
            }
        } else if (capsLockWarning) {
            capsLockWarning.remove();
        }
    });

    // Performance tracking
    const startTime = performance.now();
    window.addEventListener('load', function() {
        const loadTime = performance.now() - startTime;
        if (loadTime > 2000) {
            console.warn('Login page loaded slowly:', Math.round(loadTime), 'ms');
        }
    });
</script>

<!-- Structured data for better SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Sign In - <%= locals.trust?.name || 'School ERP' %>",
  "description": "Secure login to <%= locals.trust?.name || 'School ERP' %> system",
  "url": "<%= locals.currentUrl %>",
  "provider": {
    "@type": "Organization",
    "name": "<%= locals.trust?.name || 'School ERP' %>"
  }
}
</script>